<script type="text/javascript">
  // ===== Twitch embed: auto-parent based on current hostname =====
  (function initTwitchEmbeds() {
    var host = window.location.hostname || "ashrated.github.io";
    var parent = encodeURIComponent(host);
    var channel = "ashrated";

    document.getElementById("twitchPlayer").src =
      "https://player.twitch.tv/?channel=" + encodeURIComponent(channel) +
      "&parent=" + parent + "&muted=false";

    document.getElementById("twitchChat").src =
      "https://www.twitch.tv/embed/" + encodeURIComponent(channel) +
      "/chat?parent=" + parent + "&darkpopout=true";
  })();

  // ===== Tabs (no Angular) =====
  var selectedTab = 1;
  var panels = { 1: "items", 2: "events", 3: "traits", 4: "commands", 5: "manual" };

  function setTab(n) {
    selectedTab = n;

    // button styles
    var btns = document.querySelectorAll(".btn-tab");
    for (var i = 0; i < btns.length; i++) {
      var tab = parseInt(btns[i].getAttribute("data-tab"), 10);
      btns[i].classList.remove("active-1","active-2","active-3","active-4","active-5");
      if (tab === n) btns[i].classList.add("active-" + n);
    }

    // panels
    for (var k in panels) {
      if (!panels.hasOwnProperty(k)) continue;
      var el = document.getElementById(panels[k]);
      if (!el) continue;
      el.style.display = (parseInt(k, 10) === n) ? "" : "none";
    }

    // filter visibility
    var filterRow = document.getElementById("filterRow");
    var priceRow = document.getElementById("priceRow");

    if (n === 5) {
      filterRow.style.display = "none";
      return;
    }
    filterRow.style.display = "";
    priceRow.style.display = (n === 4) ? "none" : "";

    applyFilters();
  }

  var tabButtons = document.querySelectorAll(".btn-tab");
  for (var b = 0; b < tabButtons.length; b++) {
    tabButtons[b].addEventListener("click", function() {
      setTab(parseInt(this.getAttribute("data-tab"), 10));
    });
  }

  // default tab
  setTab(1);

  // ===== Lists =====
  var itemList = null, eventList = null, traitList = null, commandList = null;

  var statusLine = document.getElementById("statusLine");
  var errorBox = document.getElementById("errorBox");

  function setStatus(msg) { statusLine.textContent = msg; }
  function showError(msg) { errorBox.textContent = msg; errorBox.style.display = "block"; }
  function clearError() { errorBox.textContent = ""; errorBox.style.display = "none"; }

  function toNumber(x) {
    var n = Number(x);
    return isFinite(n) ? n : 0;
  }

  function getActiveList() {
    if (selectedTab === 1) return itemList;
    if (selectedTab === 2) return eventList;
    if (selectedTab === 3) return traitList;
    if (selectedTab === 4) return commandList;
    return null;
  }

  function applyFilters() {
    var list = getActiveList();
    if (!list) return;

    var search = (document.getElementById("searchBar").value || "").trim();
    var maxRaw = document.getElementById("priceMax").value;
    var max = (maxRaw === "" ? null : toNumber(maxRaw));

    list.search(search);

    // No price filtering for Commands tab
    if (selectedTab === 4 || max === null) {
      list.filter(); // clears
      return;
    }

    list.filter(function(item) {
      var v = item.values();
      // Inventory/Incidents -> price, Genetics -> add
      var p = (v.price !== undefined) ? toNumber(v.price)
            : (v.add !== undefined) ? toNumber(v.add)
            : 0;
      return p <= max;
    });
  }

  document.getElementById("searchBar").addEventListener("keyup", applyFilters);
  document.getElementById("priceMax").addEventListener("keyup", applyFilters);
  document.getElementById("priceMax").addEventListener("change", applyFilters);

  // ===== Load JSON (jQuery) with clear errors =====
  function loadJSON(url, onOk) {
    return $.getJSON(url)
      .done(onOk)
      .fail(function(xhr) {
        var code = xhr && xhr.status ? ("HTTP " + xhr.status) : "Network/blocked";
        showError("Failed to load: " + url + " (" + code + ")");
        setStatus("SYSTEM: One or more feeds failed to load.");
      });
  }

  // IMPORTANT: Make sure these constants exist above this script:
  // itemListURL, eventListURL, shopExtURL, commandsURL

  clearError();
  setStatus("BOOT: Connecting to GitHub data feeds…");

  // Inventory
  setStatus("BOOT: Loading Inventory…");
  loadJSON(itemListURL, function(itemsData) {
    var items = (itemsData && itemsData.items) ? itemsData.items : [];
    items = items.filter(function(i) { return toNumber(i.price) > 0; });

    itemList = new List("items", {
      valueNames: ["abr", "price", "category"],
      item: '<tr><td class="abr font-weight-bold"></td><td class="price text-success"></td><td class="category opacity-50"></td></tr>'
    }, items);

    applyFilters();
    setStatus("BOOT: Inventory online.");
  });

  // Incidents
  setStatus("BOOT: Loading Incidents…");
  loadJSON(eventListURL, function(eventsData) {
    var inc = (eventsData && eventsData.incitems) ? eventsData.incitems : [];
    inc = inc.filter(function(i) { return toNumber(i.price) > 0; });

    eventList = new List("events", {
      valueNames: ["abr", "price", "karmatype"],
      item: '<tr><td class="abr font-weight-bold"></td><td class="price text-danger"></td><td class="karmatype"></td></tr>'
    }, inc);

    applyFilters();
    setStatus("BOOT: Incidents online.");
  });

  // Genetics
  setStatus("BOOT: Loading Genetics…");
  loadJSON(shopExtURL, function(ext) {
    var combined = [];

    if (ext && ext.traits && ext.traits.length) {
      for (var i = 0; i < ext.traits.length; i++) {
        var t = ext.traits[i];
        combined.push({
          name: t.defName,
          desc: t.description || "",
          add: toNumber(t.addPrice),
          rem: toNumber(t.removePrice)
        });
      }
    }

    if (ext && ext.races && ext.races.length) {
      for (var r = 0; r < ext.races.length; r++) {
        var race = ext.races[r];
        if (race && race.enabled) {
          combined.push({
            name: race.defName + " (Race)",
            desc: race.description || "",
            add: toNumber(race.price),
            rem: "N/A"
          });
        }
      }
    }

    traitList = new List("traits", {
      valueNames: ["name", "desc", "add", "rem"],
      item: '<tr><td class="name text-warning font-weight-bold"></td><td class="desc small"></td><td class="add"></td><td class="rem"></td></tr>'
    }, combined);

    applyFilters();
    setStatus("BOOT: Genetics online.");
  });

  // Commands
  setStatus("BOOT: Loading Terminal Commands…");
  loadJSON(commandsURL, function(cmds) {
    var arr = Array.isArray(cmds) ? cmds : [];

    commandList = new List("commands", {
      valueNames: ["usage", "description", "userLevel"],
      item: '<tr><td class="usage cmd-text"></td><td class="description small"></td><td class="userLevel font-weight-bold"></td></tr>'
    }, arr);

    applyFilters();
    setStatus("SYSTEM: Data feeds online. Ready.");
  });
</script>
