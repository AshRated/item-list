<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no" />

  <title>AshRated // Colony Command Console</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>

  <script>
    // === YOUR LIVE JSON FEEDS (GitHub) ===
    const itemListURL     = "https://raw.githubusercontent.com/AshRated/item-list/master/StoreItems.json";
    const incidentListURL = "https://raw.githubusercontent.com/AshRated/item-list/master/StoreIncidents.json";
    const shopExtURL      = "https://raw.githubusercontent.com/AshRated/item-list/master/ShopExt.json";
    const commandsURL     = "https://raw.githubusercontent.com/AshRated/item-list/master/commands.json";
    const viewerDataURL   = "https://raw.githubusercontent.com/AshRated/item-list/master/viewerdata/ViewerData.json";

    const twitchChannel   = "ashrated";
    const twitchParent    = "ashrated.github.io"; // IMPORTANT

    // üö´ Excluded Users from Leaderboards/Lookup/PotD
    const excludedUsers = new Set(["ashrated", "ashbotrated"]);
  </script>

  <style>
    body {
      background-color: #0d1117;
      font-family: Verdana, Geneva, sans-serif;
      color: #d2d2d2;
      padding-top: 70px;
    }

    /* Scanline overlay */
    body::before {
      content: " ";
      display: block;
      position: fixed;
      top: 0; left: 0; bottom: 0; right: 0;
      background:
        linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%),
        linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
      z-index: 9999;
      background-size: 100% 2px, 3px 100%;
      pointer-events: none;
    }

    .navbar {
      background-color: #1e2328 !important;
      border-bottom: 3px solid #3c444d;
    }
    .navbar-brand { font-weight: bold; color: #d2d2d2 !important; letter-spacing: 1px; }

    .rim-window {
      background-color: #262d33;
      border: 2px solid #3c444d;
      border-radius: 4px;
      padding: 18px;
      margin-bottom: 18px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }

    .btn-tab {
      background-color: #313a42; color: #d2d2d2; border: 1px solid #4a545e;
      border-bottom: none; padding: 10px 22px; margin-right: 6px;
      border-radius: 4px 4px 0 0; font-size: .85rem; cursor: pointer;
      text-transform: uppercase; user-select: none;
    }
    .btn-tab:hover { background-color: #4a545e; color:#fff; }
    .btn-tab.active-1 { background-color:#ecf0f1; color:#000; font-weight:bold; }
    .btn-tab.active-2 { background-color:#2ecc71; color:#000; font-weight:bold; }
    .btn-tab.active-3 { background-color:#e74c3c; color:#fff; font-weight:bold; }
    .btn-tab.active-4 { background-color:#f1c40f; color:#000; font-weight:bold; }
    .btn-tab.active-5 { background-color:#3498db; color:#fff; font-weight:bold; }
    .btn-tab.active-6 { background-color:#e67e22; color:#fff; font-weight:bold; }
    .btn-tab.active-7 { background-color:#9b59b6; color:#fff; font-weight:bold; }

    .table { background-color: rgba(0,0,0,0.2); border: 1px solid #3c444d; color:#d2d2d2; }
    .table thead th { border-bottom: 2px solid #3c444d; color:#a1a1a1; font-size:.8rem; cursor: pointer; user-select: none; }
    .table thead th:hover { color: #fff; background: rgba(255,255,255,0.1); }
    .table-hover tbody tr:hover { background-color: rgba(255,255,255,0.05); }

    .rim-input {
      background-color: #0d1117; border: 1px solid #4a545e;
      color: #00bc8c; font-family: 'JetBrains Mono', monospace;
    }

    .twitch-wrapper { border: 4px solid #3c444d; background: #000; height: 500px; }

    .cmd-text { font-family: 'JetBrains Mono', monospace; color:#00bc8c; }
    .muted { opacity: .65; }
    .badge-soft { background: rgba(46,204,113,.12); border:1px solid rgba(46,204,113,.35); color:#bff3df; }

    /* Sticky Command Builder */
    .sticky-builder {
      position: sticky;
      top: 65px; /* Sits just below navbar */
      z-index: 1020;
      box-shadow: 0 8px 15px rgba(0,0,0,0.6);
    }

    .toast-mini {
      position: fixed; bottom: 18px; right: 18px; z-index: 10000;
      background: rgba(0,0,0,.85); border: 1px solid #3c444d;
      padding: 10px 12px; border-radius: 6px; display: none; max-width: 360px;
    }

    .builder { display:flex; gap:10px; align-items:stretch; flex-wrap:wrap; }
    .builder .builder-input { flex: 1 1 360px; min-width: 260px; }
    .builder button { white-space: nowrap; }
    .chaos-btn { background:#e74c3c; color:#fff; border:none; padding:8px 12px; margin-top:10px; font-weight:bold; cursor:pointer;}
    .chaos-btn:hover { background:#c0392b; }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-md navbar-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ASH RATED // COLONY COMMAND CONSOLE</a>
      <div class="ml-auto d-flex align-items-center" style="gap:10px;">
        <span id="statusBadge" class="badge badge-success p-2">SYSTEMS ONLINE</span>
        <span id="statusText" class="badge badge-soft p-2">BOOT: Awaiting data feeds‚Ä¶</span>
      </div>
    </div>
  </nav>

  <main class="container-fluid mt-4 px-lg-5">

    <div class="row">
      <div class="col-lg-9 mb-3">
        <div class="twitch-wrapper">
          <iframe id="twitchPlayer" src="" height="100%" width="100%" frameborder="0" allowfullscreen="true"></iframe>
        </div>
      </div>
      <div class="col-lg-3 mb-3">
        <div class="twitch-wrapper">
          <iframe id="twitchChat" src="" height="100%" width="100%" frameborder="0"></iframe>
        </div>
      </div>
    </div>

    <div class="d-flex flex-wrap mt-2">
      <div class="btn-tab" id="tabBtn1">Home</div>
      <div class="btn-tab" id="tabBtn2">Inventory</div>
      <div class="btn-tab" id="tabBtn3">Incidents</div>
      <div class="btn-tab" id="tabBtn4">Genetics</div>
      <div class="btn-tab" id="tabBtn5">Terminal</div>
      <div class="btn-tab" id="tabBtn6">Leaderboards</div>
      <div class="btn-tab" id="tabBtn7">Manual</div>
    </div>

    <div class="rim-window">

      <div class="rim-window sticky-builder" style="margin-bottom:16px;">
        <div class="d-flex align-items-center justify-content-between flex-wrap" style="gap:10px;">
          <div>
            <div class="text-uppercase muted" style="font-size:.78rem;">Command Builder</div>
            <div class="muted" style="font-size:.85rem;">Click any row to auto-build a command. Then copy & paste into Twitch chat.</div>
          </div>
        </div>
        <div class="builder mt-2">
          <input id="builderInput" class="form-control rim-input builder-input" placeholder="Click a row to populate a command‚Ä¶" />
          <button class="btn btn-sm btn-outline-light" id="copyBtn">Copy</button>
          <button class="btn btn-sm btn-primary" id="copyOpenBtn">Copy & Chat</button>
          <button class="btn btn-sm btn-outline-danger" id="clearBtn">Clear</button>
        </div>
        <div class="mt-2 muted small" id="builderHint">Waiting for selection‚Ä¶</div>
      </div>

      <div class="row mb-3" id="filterRow" style="display:none;">
        <div class="col-md-8">
          <div class="input-group">
            <div class="input-group-prepend"><span class="input-group-text rim-input border-right-0">FILTER_QUERY:</span></div>
            <input type="text" id="searchBar" class="form-control rim-input" placeholder="Type to search current tab‚Ä¶" />
          </div>
        </div>
        <div class="col-md-4" id="priceBox">
          <div class="input-group">
            <div class="input-group-prepend"><span class="input-group-text rim-input border-right-0">$</span></div>
            <input type="number" id="priceMax" class="form-control rim-input" placeholder="Max Price (optional)" />
          </div>
        </div>
      </div>

      <div id="displayArea">
        
        <div id="home" class="tab-panel">
          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="rim-window mb-3">
                <h5 class="text-warning">üèÜ Pawn of the Day</h5>
                <div id="potdBox" class="cmd-text" style="font-size:1.2rem;">Awaiting Data...</div>
                <div class="small muted">Updates daily based on colony logs.</div>
              </div>
              <div class="rim-window mb-3">
                <h5 class="text-danger">üòà Most Evil Pawn</h5>
                <div id="evilBox" class="cmd-text" style="font-size:1.2rem;">Awaiting Data...</div>
                <div class="small muted">Currently active pawn with the highest karma.</div>
              </div>
              <button class="chaos-btn w-100" onclick="triggerChaos()">üé≤ GENERATE RANDOM CHAOS COMMAND</button>
              <div id="raidAlert" class="mt-3 text-danger font-weight-bold" style="font-size:1.2rem;"></div>
            </div>

            <div class="col-md-6 mb-3">
              <div class="rim-window mb-3">
                <h5 class="text-info">üîé Viewer Lookup</h5>
                <div class="d-flex mb-2">
                  <input type="text" id="viewerSearch" class="form-control rim-input mr-2" placeholder="Twitch Username" />
                  <button class="btn btn-sm btn-primary" id="viewerLookupBtn">Check</button>
                </div>
                <div id="viewerResult" class="small muted p-2" style="background:rgba(0,0,0,0.3); border-radius:4px;">Type a name to check stats.</div>
              </div>

              <div class="rim-window">
                <h5 class="text-secondary">üíÄ Death Tracker</h5>
                <div id="deathBox" class="small muted">
                  No fallen colonists detected in current logs.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="items" class="tab-panel" style="display:none;">
          <table class="table table-hover">
            <thead><tr>
              <th class="sort" data-sort="abr">OBJECT_ID ‚Üï</th>
              <th class="sort" data-sort="price">PRICE ‚Üï</th>
              <th class="sort" data-sort="category">CATEGORY ‚Üï</th>
            </tr></thead>
            <tbody class="list"></tbody>
          </table>
        </div>

        <div id="incidents" class="tab-panel" style="display:none;">
          <table class="table table-hover">
            <thead><tr>
              <th class="sort" data-sort="abr">INCIDENT_ID ‚Üï</th>
              <th class="sort" data-sort="price">PRICE ‚Üï</th>
              <th class="sort" data-sort="karmatype">KARMA ‚Üï</th>
              <th>ACTIONS</th>
            </tr></thead>
            <tbody class="list"></tbody>
          </table>
        </div>

        <div id="traits" class="tab-panel" style="display:none;">
          <table class="table table-hover">
            <thead><tr>
              <th class="sort" data-sort="name">MOD_ID ‚Üï</th>
              <th>FUNCTION</th>
              <th class="sort" data-sort="add">ADD_COST ‚Üï</th>
              <th class="sort" data-sort="rem">REM_COST ‚Üï</th>
              <th>ACTIONS</th>
            </tr></thead>
            <tbody class="list"></tbody>
          </table>
        </div>

        <div id="commands" class="tab-panel" style="display:none;">
          <table class="table table-hover">
            <thead><tr>
              <th class="sort" data-sort="usage">INPUT_STRING ‚Üï</th>
              <th>OPERATION</th>
              <th class="sort" data-sort="userLevel">ACCESS ‚Üï</th>
            </tr></thead>
            <tbody class="list"></tbody>
          </table>
        </div>

        <div id="leaderboards" class="tab-panel" style="display:none;">
          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="rim-window">
                <div class="d-flex align-items-center justify-content-between">
                  <h5 class="text-success mb-2">üí∞ Top 10 Richest</h5>
                  <span class="muted small" id="coinsUpdated">‚Äî</span>
                </div>
                <table class="table table-sm mb-0">
                  <thead><tr><th>Viewer</th><th>Coins</th></tr></thead>
                  <tbody id="coinsBoard"></tbody>
                </table>
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <div class="rim-window">
                <div class="d-flex align-items-center justify-content-between">
                  <h5 class="text-danger mb-2">üî• Top 10 Karma</h5>
                  <span class="muted small" id="karmaUpdated">‚Äî</span>
                </div>
                <table class="table table-sm mb-0">
                  <thead><tr><th>Viewer</th><th>Karma</th></tr></thead>
                  <tbody id="karmaBoard"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div id="manual" class="tab-panel" style="display:none;">
          <h2 class="text-uppercase mb-4" style="color:#9b59b6">Instructional Manual</h2>
          <div class="row">
            <div class="col-md-6">
              <div class="guide-box bg-dark border-left border-success p-3 mb-3">
                <h5 class="text-success">CREDIT ACCUMULATION</h5>
                <p class="small mb-0">Watch time generates passive Silver. Check wallet with <span class="cmd-text">!bal</span>.</p>
              </div>
              <div class="guide-box bg-dark border-left border-info p-3 mb-3">
                <h5 class="text-info">SUPPLY REQUISITION</h5>
                <p class="small mb-0">Items drop via trade pod. Format: <span class="cmd-text">!buy [item] [qty]</span>.</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="guide-box bg-dark border-left border-warning p-3 mb-3">
                <h5 class="text-warning">COLONIST INTEGRATION</h5>
                <p class="small mb-0">Enter the queue with <span class="cmd-text">!joinqueue</span>. Check your pawn with <span class="cmd-text">!mypawnskills</span>.</p>
              </div>
              <div class="guide-box bg-dark border-left border-danger p-3 mb-3">
                <h5 class="text-danger">INCIDENT TRIGGER</h5>
                <p class="small mb-0">Triggers events. Hostile incidents cost more. Format: <span class="cmd-text">!buy [incident]</span>.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer class="text-center pb-5 small muted">SYSTEM VERSION 4.0 // ASHRATED_OS</footer>
  </main>

  <div class="toast-mini" id="toast"></div>

  <script>
    // =========================
    // UI Helpers
    // =========================
    function setStatus(text, ok=true) {
      $("#statusText").text(text);
      $("#statusBadge").toggleClass("badge-success", ok).toggleClass("badge-danger", !ok);
      $("#statusBadge").text(ok ? "SYSTEMS ONLINE" : "SYSTEM ERROR");
    }

    function toast(msg) {
      const t = $("#toast");
      t.text(msg).stop(true,true).fadeIn(120);
      setTimeout(() => t.fadeOut(250), 1400);
    }

    function setBuilder(cmdText, hintText) {
      $("#builderInput").val(cmdText);
      $("#builderHint").text(hintText || "Command ready. Copy & paste into chat.");
      
      // Flash animation on builder to show it updated
      $(".sticky-builder").css("outline", "2px solid #00bc8c");
      setTimeout(() => $(".sticky-builder").css("outline", "none"), 300);
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        toast("Copied to clipboard!");
      } catch {
        const inp = document.getElementById("builderInput");
        inp.select(); document.execCommand("copy");
        toast("Copied (fallback)!");
      }
    }

    function openTwitchChat() {
      window.open(`https://www.twitch.tv/popout/${twitchChannel}/chat?popout=`, "_blank");
    }

    function triggerChaos() {
      const cmds = ["!buy raid", "!buy meteor", "!buy manhunter", "!buy toxicfallout", "!buy eclipse", "!buy infestation"];
      const pick = cmds[Math.floor(Math.random()*cmds.length)];
      setBuilder(pick, "üé≤ CHAOS SELECTED. COPY AND DEPLOY IF YOU DARE.");
    }

    // =========================
    // Tabs & Filters
    // =========================
    let activeTab = 1; 

    function showTab(tab) {
      activeTab = tab;
      for(let i=1; i<=7; i++) {
        $(`#tabBtn${i}`).attr("class", "btn-tab" + (tab===i ? ` active-${i}` : ""));
      }

      $("#home").toggle(tab===1);
      $("#items").toggle(tab===2);
      $("#incidents").toggle(tab===3);
      $("#traits").toggle(tab===4);
      $("#commands").toggle(tab===5);
      $("#leaderboards").toggle(tab===6);
      $("#manual").toggle(tab===7);

      // Search/Filter row only shows on Lists (Tabs 2,3,4,5)
      $("#filterRow").toggle(tab >= 2 && tab <= 5);
      $("#priceBox").toggle(tab === 2 || tab === 3 || tab === 4); 

      $("#searchBar").val(""); $("#priceMax").val("");
      applyFiltersToActive(); applySearchToActive("");
    }

    for(let i=1; i<=7; i++) { $(`#tabBtn${i}`).on("click", () => showTab(i)); }

    // =========================
    // Data Loading Utilities
    // =========================
    async function loadJSON(url) {
      const res = await fetch(url + "?cb=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return await res.json();
    }

    let itemList = null, incidentList = null, traitList = null, commandList = null;

    function getActiveList() {
      if (activeTab === 2) return itemList;
      if (activeTab === 3) return incidentList;
      if (activeTab === 4) return traitList;
      if (activeTab === 5) return commandList;
      return null;
    }

    function applySearchToActive(q) { const L = getActiveList(); if (L) L.search(q); }
    function applyFiltersToActive() {
      const L = getActiveList(); if (!L) return;
      const maxStr = ($("#priceMax").val() || "").trim();
      const max = maxStr === "" ? null : Number(maxStr);

      if (max !== null && (Number.isNaN(max) || max < 0)) { L.filter(); return; }

      if (activeTab >= 2 && activeTab <= 4) {
        L.filter(item => {
          const p = Number(item.values().price || 0);
          return (max === null) ? true : (p <= max);
        });
      } else { L.filter(); }
    }

    // =========================
    // ViewerData: Home & Leaderboards
    // =========================
    async function loadViewerData() {
      try {
        const res = await fetch(viewerDataURL + "?cb=" + Date.now(), { cache: "no-store" });
        const data = await res.json();
        if (!data || !data.viewers) return;

        // Filter out excluded users
        const viewers = (Array.isArray(data.viewers) ? data.viewers : [])
                        .filter(v => !excludedUsers.has((v.username||"").toLowerCase()));

        // Update Leaderboards
        const topCoins = [...viewers].sort((a,b) => (b.coins||0) - (a.coins||0)).slice(0,10);
        const topKarma = [...viewers].sort((a,b) => (b.karma||0) - (a.karma||0)).slice(0,10);

        $("#coinsBoard").html(topCoins.map(v => `<tr><td>${escapeHtml(v.username||"")}</td><td class="text-success">${Number(v.coins||0)}</td></tr>`).join(""));
        $("#karmaBoard").html(topKarma.map(v => `<tr><td>${escapeHtml(v.username||"")}</td><td class="text-danger">${Number(v.karma||0)}</td></tr>`).join(""));
        
        const now = new Date().toLocaleTimeString();
        $("#coinsUpdated").text(`Updated ${now}`); $("#karmaUpdated").text(`Updated ${now}`);

        // Update Pawn of the Day (Locked by Date Hash so it stays consistent for the day)
        const pawns = viewers.filter(x => x.pawnName);
        if(pawns.length > 0) {
            let todayStr = new Date().toDateString();
            let hash = 0; for(let i=0; i<todayStr.length; i++) hash += todayStr.charCodeAt(i);
            let potd = pawns[hash % pawns.length];
            $("#potdBox").html(`${escapeHtml(potd.username)} <span class="text-white">‚Üí</span> ${escapeHtml(potd.pawnName)}`);
        }

        // Update Evil Pawn
        if(viewers.length > 0) {
            let evil = [...viewers].sort((a,b) => (b.karma||0) - (a.karma||0))[0];
            if(evil) $("#evilBox").html(`${escapeHtml(evil.username)} <span class="text-white">‚Üí</span> ${escapeHtml(evil.pawnName || "No Pawn")} (${evil.karma})`);
        }

        // Raid Detection
        let raid = viewers.find(x => x.karma > 5000);
        if(raid) $("#raidAlert").text(`‚ö†Ô∏è RAID WARNING: ${escapeHtml(raid.username)} HAS EXTREME KARMA!`);
        else $("#raidAlert").text("");

        // Death Tracker (Checks if JSON passes 'isDead' or 'status' flag. Expand as needed)
        let deadPawns = viewers.filter(x => x.isDead || x.status === "dead" || x.status === "deceased");
        if(deadPawns.length > 0) {
            $("#deathBox").html(deadPawns.map(d => `<div class="text-danger">‚ò†Ô∏è ${escapeHtml(d.username)} (${escapeHtml(d.pawnName)})</div>`).join(""));
        }

      } catch (e) { console.log("ViewerData load error:", e); }
    }

    function escapeHtml(s) {
      return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    async function lookupViewer() {
      const name = ($("#viewerSearch").val() || "").trim().toLowerCase();
      if (!name) return $("#viewerResult").text("Please enter a username.");
      if (excludedUsers.has(name)) return $("#viewerResult").html("<span class='text-danger'>SYSTEM DENIED: User is excluded from database.</span>");

      try {
        const res = await fetch(viewerDataURL + "?cb=" + Date.now(), { cache: "no-store" });
        const data = await res.json();
        const viewers = Array.isArray(data.viewers) ? data.viewers : [];
        const v = viewers.find(x => (x.username||"").toLowerCase() === name);

        if (!v) return $("#viewerResult").text("User not found in the colony database.");

        const pawn = v.pawnName || v.pawn || v.colonist || "Not assigned";
        $("#viewerResult").html(
          `User: <span class="cmd-text">${escapeHtml(v.username)}</span> | üßë Pawn: <b class="text-white">${escapeHtml(pawn)}</b><br>` +
          `üí∞ Coins: <b>${Number(v.coins||0)}</b> | üî• Karma: <b>${Number(v.karma||0)}</b>`
        );
      } catch (e) { $("#viewerResult").text("Lookup failed."); }
    }

    $("#viewerLookupBtn").on("click", lookupViewer);
    $("#viewerSearch").on("keydown", function(e){ if(e.key==="Enter") lookupViewer(); });

    // =========================
    // Boot: Load Lists
    // =========================
    async function boot() {
      $("#twitchPlayer").attr("src", `https://player.twitch.tv/?channel=${twitchChannel}&parent=${twitchParent}&muted=false`);
      $("#twitchChat").attr("src", `https://www.twitch.tv/embed/${twitchChannel}/chat?parent=${twitchParent}&darkpopout`);

      setStatus("BOOT: Loading Inventory‚Ä¶");
      try {
        const data = await loadJSON(itemListURL);
        const items = (data && Array.isArray(data.items)) ? data.items : [];
        const normalized = items.filter(i => Number(i.price || 0) > 0).map(i => ({
            abr: i.abr || i.name || i.defName || "", price: Number(i.price || 0), category: i.category || i.type || "‚Äî"
        }));
        itemList = new List("items", { valueNames: ["abr","price","category"], item: `<tr><td class="abr font-weight-bold" style="cursor:pointer;"></td><td class="price text-success"></td><td class="category muted"></td></tr>` }, normalized);
      } catch (e) { setStatus("ERROR: Inventory feed failed.", false); }

      setStatus("BOOT: Loading Incidents‚Ä¶");
      try {
        const data = await loadJSON(incidentListURL);
        const inc = (data && Array.isArray(data.incitems)) ? data.incitems : [];
        const normalized = inc.filter(i => Number(i.price || 0) > 0).map(i => ({
            abr: i.abr || i.name || i.defName || "", price: Number(i.price || 0), karmatype: i.karmatype || i.karmaType || i.karma || "‚Äî"
        }));
        // Note: added Vote button in HTML template
        incidentList = new List("incidents", { 
            valueNames: ["abr","price","karmatype"], 
            item: `<tr><td class="abr font-weight-bold" style="cursor:pointer;"></td><td class="price text-danger"></td><td class="karmatype"></td><td><button class="btn btn-sm btn-outline-info vote-btn">Start Vote</button></td></tr>` 
        }, normalized);
      } catch (e) { setStatus("ERROR: Incidents feed failed.", false); }

      setStatus("BOOT: Loading Genetics‚Ä¶");
      try {
        const data = await loadJSON(shopExtURL);
        const combined = [];
        if (data && Array.isArray(data.traits)) {
          data.traits.forEach(t => combined.push({ name: t.defName || t.name || "", desc: t.description || "", add: Number(t.addPrice || 0), rem: Number(t.removePrice || 0), price: Number(t.addPrice || 0) }));
        }
        if (data && Array.isArray(data.races)) {
          data.races.filter(r => r.enabled).forEach(r => combined.push({ name: (r.defName || r.name || "") + " (Race)", desc: r.description || "", add: Number(r.price || 0), rem: "N/A", price: Number(r.price || 0) }));
        }
        
        traitList = new List("traits", { 
            valueNames: ["name","desc","add","rem","price"], 
            item: `<tr><td class="name text-warning font-weight-bold" style="cursor:pointer;"></td><td class="desc small"></td><td class="add text-success"></td><td class="rem text-danger"></td><td><button class="btn btn-sm btn-success install-btn mr-1">Install</button><button class="btn btn-sm btn-danger remove-btn">Remove</button></td></tr>` 
        }, combined);
      } catch (e) { setStatus("ERROR: Genetics feed failed.", false); }

      setStatus("BOOT: Loading Terminal Commands‚Ä¶");
      try {
        const cmds = await loadJSON(commandsURL);
        const arr = Array.isArray(cmds) ? cmds : [];
        arr.forEach(c => { c.name = c.usage || c.name || ""; c.price = 0; });
        commandList = new List("commands", { valueNames: ["usage","description","userLevel"], item: `<tr><td class="usage cmd-text" style="cursor:pointer;"></td><td class="description small"></td><td class="userLevel font-weight-bold"></td></tr>` }, arr);
      } catch (e) { setStatus("ERROR: Commands feed failed.", false); }

      // =========================
      // Row & Button Click Handlers
      // =========================
      
      // Items Tab Click
      $("#items tbody").on("click", "td.abr", function() {
        const name = $(this).text().trim();
        setBuilder(`!buy ${name} 1`, `Item selected. Edit quantity if needed, then copy.`);
      });

      // Incidents Tab Click
      $("#incidents tbody").on("click", "td.abr", function() {
        setBuilder(`!buy ${$(this).text().trim()}`, `Incident selected. Copy and run in chat.`);
      });
      // Incident Vote Button Click
      $("#incidents tbody").on("click", ".vote-btn", function() {
        const name = $(this).closest("tr").find(".abr").text().trim();
        setBuilder(`!vote ${name}`, `Voting command ready for incident: ${name}`);
      });

      // Genetics Tab Click
      $("#traits tbody").on("click", "td.name", function() {
        setBuilder(`!trait ${$(this).text().trim()}`, `Genetics selected. Adjust format if needed.`);
      });
      // Genetics Install/Remove Buttons
      $("#traits tbody").on("click", ".install-btn", function() {
        const name = $(this).closest("tr").find(".name").text().trim().replace(" (Race)", "");
        setBuilder(`!trait add ${name}`, `Install Gene command ready.`);
      });
      $("#traits tbody").on("click", ".remove-btn", function() {
        const name = $(this).closest("tr").find(".name").text().trim().replace(" (Race)", "");
        setBuilder(`!trait remove ${name}`, `Remove Gene command ready.`);
      });

      // Terminal Tab Click
      $("#commands tbody").on("click", "td.usage", function() {
        setBuilder($(this).text().trim(), `Terminal command selected. Copy and run in chat.`);
      });

      // Search + Filters
      $("#searchBar").on("keyup", function() { applySearchToActive($(this).val() || ""); });
      $("#priceMax").on("keyup change", function() { applyFiltersToActive(); });

      // Builder buttons
      $("#copyBtn").on("click", async () => {
        const val = $("#builderInput").val() || "";
        if (!val.trim()) return toast("Nothing to copy.");
        await copyToClipboard(val);
      });
      $("#copyOpenBtn").on("click", async () => {
        const val = $("#builderInput").val() || "";
        if (!val.trim()) return toast("Nothing to copy.");
        await copyToClipboard(val);
        openTwitchChat();
      });
      $("#clearBtn").on("click", () => setBuilder("", "Waiting for selection‚Ä¶"));

      showTab(1); // Start on Home
      loadViewerData(); setInterval(loadViewerData, 5000); // Start Leaderboard loop
      setStatus("SYSTEM: Data feeds online. Ready.");
    }

    boot();
  </script>
</body>
</html>
