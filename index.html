<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no" />

  <title>AshRated // Colony Command Console</title>

  <!-- Bootstrap 4 -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />

  <!-- jQuery + list.js -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>

  <script>
    // === YOUR LIVE JSON FEEDS (GitHub) ===
    // Repo: https://ashrated.github.io/item-list/
    const itemListURL     = "https://raw.githubusercontent.com/AshRated/item-list/master/StoreItems.json";
    const incidentListURL = "https://raw.githubusercontent.com/AshRated/item-list/master/StoreIncidents.json"; // <- incidents, not StoreEvents
    const shopExtURL      = "https://raw.githubusercontent.com/AshRated/item-list/master/ShopExt.json";
    const commandsURL     = "https://raw.githubusercontent.com/AshRated/item-list/master/commands.json";

    // Live viewer feed (uploaded by Mix It Up)
    const viewerDataURL   = "https://raw.githubusercontent.com/AshRated/item-list/master/viewerdata/ViewerData.json";

    // Twitch embeds must include your GitHub Pages domain as parent
    const twitchChannel   = "ashrated";
    const twitchParent    = "ashrated.github.io"; // IMPORTANT
  </script>

  <style>
    body {
      background-color: #0d1117;
      font-family: Verdana, Geneva, sans-serif;
      color: #d2d2d2;
      padding-top: 70px;
    }

    /* Scanline overlay */
    body::before {
      content: " ";
      display: block;
      position: fixed;
      top: 0; left: 0; bottom: 0; right: 0;
      background:
        linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%),
        linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
      z-index: 9999;
      background-size: 100% 2px, 3px 100%;
      pointer-events: none;
    }

    .navbar {
      background-color: #1e2328 !important;
      border-bottom: 3px solid #3c444d;
    }
    .navbar-brand {
      font-weight: bold;
      color: #d2d2d2 !important;
      letter-spacing: 1px;
    }

    .rim-window {
      background-color: #262d33;
      border: 2px solid #3c444d;
      border-radius: 4px;
      padding: 18px;
      margin-bottom: 18px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }

    .btn-tab {
      background-color: #313a42;
      color: #d2d2d2;
      border: 1px solid #4a545e;
      border-bottom: none;
      padding: 10px 22px;
      margin-right: 6px;
      border-radius: 4px 4px 0 0;
      font-size: .85rem;
      cursor: pointer;
      text-transform: uppercase;
      user-select: none;
    }
    .btn-tab:hover { background-color: #4a545e; color:#fff; }
    .btn-tab.active-1 { background-color:#2ecc71; color:#000; font-weight:bold; }
    .btn-tab.active-2 { background-color:#e74c3c; color:#fff; font-weight:bold; }
    .btn-tab.active-3 { background-color:#f1c40f; color:#000; font-weight:bold; }
    .btn-tab.active-4 { background-color:#3498db; color:#fff; font-weight:bold; }
    .btn-tab.active-5 { background-color:#9b59b6; color:#fff; font-weight:bold; }

    .table { background-color: rgba(0,0,0,0.2); border: 1px solid #3c444d; color:#d2d2d2; }
    .table thead th { border-bottom: 2px solid #3c444d; color:#a1a1a1; font-size:.8rem; }
    .table-hover tbody tr:hover { background-color: rgba(255,255,255,0.05); cursor:pointer; }

    .rim-input {
      background-color: #0d1117;
      border: 1px solid #4a545e;
      color: #00bc8c;
      font-family: 'JetBrains Mono', monospace;
    }

    .twitch-wrapper {
      border: 4px solid #3c444d;
      background: #000;
      height: 500px;
    }

    .cmd-text { font-family: 'JetBrains Mono', monospace; color:#00bc8c; }
    .muted { opacity: .65; }
    .badge-soft { background: rgba(46,204,113,.12); border:1px solid rgba(46,204,113,.35); color:#bff3df; }

    .guide-box {
      background-color: rgba(0,0,0,0.3);
      border-left: 4px solid #9b59b6;
      padding: 14px;
      margin-bottom: 14px;
    }

    .toast-mini {
      position: fixed;
      bottom: 18px;
      right: 18px;
      z-index: 10000;
      background: rgba(0,0,0,.85);
      border: 1px solid #3c444d;
      padding: 10px 12px;
      border-radius: 6px;
      display: none;
      max-width: 360px;
    }

    .builder {
      display:flex;
      gap:10px;
      align-items:stretch;
      flex-wrap:wrap;
    }
    .builder .builder-input {
      flex: 1 1 360px;
      min-width: 260px;
    }
    .builder button {
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-md navbar-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ASH RATED // COLONY COMMAND CONSOLE</a>
      <div class="ml-auto d-flex align-items-center" style="gap:10px;">
        <span id="statusBadge" class="badge badge-success p-2">SYSTEMS ONLINE</span>
        <span id="statusText" class="badge badge-soft p-2">BOOT: Awaiting data feeds‚Ä¶</span>
      </div>
    </div>
  </nav>

  <main class="container-fluid mt-4 px-lg-5">

    <!-- Stream + Chat -->
    <div class="row">
      <div class="col-lg-9 mb-3">
        <div class="twitch-wrapper">
          <iframe
            id="twitchPlayer"
            src=""
            height="100%"
            width="100%"
            frameborder="0"
            allowfullscreen="true">
          </iframe>
        </div>
      </div>
      <div class="col-lg-3 mb-3">
        <div class="twitch-wrapper">
          <iframe
            id="twitchChat"
            src=""
            height="100%"
            width="100%"
            frameborder="0">
          </iframe>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="d-flex flex-wrap mt-2">
      <div class="btn-tab" id="tabBtn1">Inventory</div>
      <div class="btn-tab" id="tabBtn2">Incidents</div>
      <div class="btn-tab" id="tabBtn3">Genetics</div>
      <div class="btn-tab" id="tabBtn4">Terminal</div>
      <div class="btn-tab" id="tabBtn5">Manual</div>
    </div>

    <div class="rim-window">

      <!-- Filters (hidden on manual) -->
      <div class="row mb-3" id="filterRow">
        <div class="col-md-8">
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text rim-input border-right-0">FILTER_QUERY:</span>
            </div>
            <input type="text" id="searchBar" class="form-control rim-input" placeholder="Type to search current tab‚Ä¶" />
          </div>
        </div>
        <div class="col-md-4" id="priceBox">
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text rim-input border-right-0">$</span>
            </div>
            <input type="number" id="priceMax" class="form-control rim-input" placeholder="Max Price (optional)" />
          </div>
        </div>
      </div>

      <!-- Command Builder -->
      <div class="rim-window" style="margin-bottom:16px;">
        <div class="d-flex align-items-center justify-content-between flex-wrap" style="gap:10px;">
          <div>
            <div class="text-uppercase muted" style="font-size:.78rem;">Command Builder</div>
            <div class="muted" style="font-size:.85rem;">Click any row to auto-build a command. Then copy & paste into Twitch chat.</div>
          </div>
          <span class="badge badge-soft p-2">Tip: Use the Terminal tab to see command syntax</span>
        </div>
        <div class="builder mt-2">
          <input id="builderInput" class="form-control rim-input builder-input" placeholder="Click a row to populate a command‚Ä¶" />
          <button class="btn btn-sm btn-outline-light" id="copyBtn">Copy</button>
          <button class="btn btn-sm btn-primary" id="copyOpenBtn">Copy & Open Twitch Chat</button>
          <button class="btn btn-sm btn-outline-danger" id="clearBtn">Clear</button>
        </div>
        <div class="mt-2 muted small" id="builderHint">Waiting for selection‚Ä¶</div>
      </div>

      <!-- Live Leaderboards + Lookup -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <div class="rim-window">
            <div class="d-flex align-items-center justify-content-between">
              <h5 class="text-success mb-2">üí∞ Top 10 Richest</h5>
              <span class="muted small" id="coinsUpdated">‚Äî</span>
            </div>
            <table class="table table-sm mb-0">
              <thead><tr><th>Viewer</th><th>Coins</th></tr></thead>
              <tbody id="coinsBoard"></tbody>
            </table>
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <div class="rim-window">
            <div class="d-flex align-items-center justify-content-between">
              <h5 class="text-danger mb-2">üî• Top 10 Karma</h5>
              <span class="muted small" id="karmaUpdated">‚Äî</span>
            </div>
            <table class="table table-sm mb-0">
              <thead><tr><th>Viewer</th><th>Karma</th></tr></thead>
              <tbody id="karmaBoard"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="rim-window">
        <h5 class="text-info mb-2">üîé Viewer Lookup</h5>
        <div class="row">
          <div class="col-md-8">
            <input type="text" id="viewerSearch" class="form-control rim-input" placeholder="Enter your Twitch username (e.g. AshRated)" />
          </div>
          <div class="col-md-4 mt-2 mt-md-0">
            <button class="btn btn-sm btn-primary w-100" id="viewerLookupBtn">Check Stats</button>
          </div>
        </div>
        <div id="viewerResult" class="mt-2 small muted">Type a name and press ‚ÄúCheck Stats‚Äù.</div>
      </div>

      <!-- Display Area -->
      <div id="displayArea">
        <!-- Inventory -->
        <div id="items" class="tab-panel">
          <table class="table table-hover">
            <thead><tr><th>OBJECT_ID</th><th>PRICE</th><th>CATEGORY</th></tr></thead>
            <tbody class="list"></tbody>
          </table>
        </div>

        <!-- Incidents -->
        <div id="incidents" class="tab-panel" style="display:none;">
          <table class="table table-hover">
            <thead><tr><th>INCIDENT_ID</th><th>PRICE</th><th>KARMA</th></tr></thead>
            <tbody class="list"></tbody>
          </table>
        </div>

        <!-- Genetics -->
        <div id="traits" class="tab-panel" style="display:none;">
          <table class="table table-hover">
            <thead><tr><th>MOD_ID</th><th>FUNCTION</th><th>ADD_COST</th><th>REM_COST</th></tr></thead>
            <tbody class="list"></tbody>
          </table>
        </div>

        <!-- Terminal -->
        <div id="commands" class="tab-panel" style="display:none;">
          <table class="table table-hover">
            <thead><tr><th>INPUT_STRING</th><th>OPERATION</th><th>ACCESS</th></tr></thead>
            <tbody class="list"></tbody>
          </table>
        </div>

        <!-- Manual -->
        <div id="manual" class="tab-panel" style="display:none;">
          <h2 class="text-uppercase mb-4" style="color:#9b59b6">Instructional Manual</h2>
          <div class="row">
            <div class="col-md-6">
              <div class="guide-box">
                <h5 class="text-success">CREDIT ACCUMULATION</h5>
                <p class="small mb-0">Watch time generates passive Silver. Check wallet with <span class="cmd-text">!bal</span>.</p>
              </div>
              <div class="guide-box">
                <h5 class="text-info">SUPPLY REQUISITION</h5>
                <p class="small mb-0">Items drop via trade pod. Format: <span class="cmd-text">!buy [item] [qty]</span>.</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="guide-box">
                <h5 class="text-warning">COLONIST INTEGRATION</h5>
                <p class="small mb-0">Enter the queue with <span class="cmd-text">!joinqueue</span>. Check your pawn with <span class="cmd-text">!mypawnskills</span>.</p>
              </div>
              <div class="guide-box">
                <h5 class="text-danger">INCIDENT TRIGGER</h5>
                <p class="small mb-0">Triggers events. Hostile incidents cost more. Format: <span class="cmd-text">!buy [incident]</span>.</p>
              </div>
            </div>
          </div>
          <div class="mt-3 muted small">
            Tip: Click any item/incident/trait/command on the other tabs to auto-fill the Command Builder.
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center pb-5 small muted">
      SYSTEM VERSION 3.2 // ASHRATED_OS
    </footer>
  </main>

  <div class="toast-mini" id="toast"></div>

  <script>
    // =========================
    // UI Helpers
    // =========================
    function setStatus(text, ok=true) {
      $("#statusText").text(text);
      $("#statusBadge").toggleClass("badge-success", ok).toggleClass("badge-danger", !ok);
      $("#statusBadge").text(ok ? "SYSTEMS ONLINE" : "SYSTEM ERROR");
    }

    function toast(msg) {
      const t = $("#toast");
      t.text(msg).stop(true,true).fadeIn(120);
      setTimeout(() => t.fadeOut(250), 1400);
    }

    function setBuilder(cmdText, hintText) {
      $("#builderInput").val(cmdText);
      $("#builderHint").text(hintText || "Command ready. Copy & paste into chat.");
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        toast("Copied to clipboard!");
      } catch {
        // fallback
        const inp = document.getElementById("builderInput");
        inp.select();
        document.execCommand("copy");
        toast("Copied (fallback)!");
      }
    }

    // Open Twitch popout chat in a new tab (easy paste)
    function openTwitchChat() {
      window.open(`https://www.twitch.tv/popout/${twitchChannel}/chat?popout=`, "_blank");
    }

    // =========================
    // Tabs
    // =========================
    let activeTab = 1; // 1 items, 2 incidents, 3 genetics, 4 terminal, 5 manual

    function showTab(tab) {
      activeTab = tab;

      // Buttons
      $("#tabBtn1").attr("class", "btn-tab" + (tab===1 ? " active-1" : ""));
      $("#tabBtn2").attr("class", "btn-tab" + (tab===2 ? " active-2" : ""));
      $("#tabBtn3").attr("class", "btn-tab" + (tab===3 ? " active-3" : ""));
      $("#tabBtn4").attr("class", "btn-tab" + (tab===4 ? " active-4" : ""));
      $("#tabBtn5").attr("class", "btn-tab" + (tab===5 ? " active-5" : ""));

      // Panels
      $("#items").toggle(tab===1);
      $("#incidents").toggle(tab===2);
      $("#traits").toggle(tab===3);
      $("#commands").toggle(tab===4);
      $("#manual").toggle(tab===5);

      // Filters
      $("#filterRow").toggle(tab !== 5);
      $("#priceBox").toggle(tab !== 4 && tab !== 5); // terminal doesn't use max-price filter nicely

      // Reset search on tab switch (prevents confusion)
      $("#searchBar").val("");
      $("#priceMax").val("");

      applyFiltersToActive();
      applySearchToActive("");
    }

    $("#tabBtn1").on("click", () => showTab(1));
    $("#tabBtn2").on("click", () => showTab(2));
    $("#tabBtn3").on("click", () => showTab(3));
    $("#tabBtn4").on("click", () => showTab(4));
    $("#tabBtn5").on("click", () => showTab(5));

    // =========================
    // Data Loading Utilities
    // =========================
    async function loadJSON(url) {
      const res = await fetch(url + "?cb=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return await res.json();
    }

    // list.js instances
    let itemList = null;
    let incidentList = null;
    let traitList = null;
    let commandList = null;

    function getActiveList() {
      if (activeTab === 1) return itemList;
      if (activeTab === 2) return incidentList;
      if (activeTab === 3) return traitList;
      if (activeTab === 4) return commandList;
      return null;
    }

    function applySearchToActive(q) {
      const L = getActiveList();
      if (!L) return;
      L.search(q);
    }

    function applyFiltersToActive() {
      const L = getActiveList();
      if (!L) return;

      const maxStr = ($("#priceMax").val() || "").trim();
      const max = maxStr === "" ? null : Number(maxStr);

      // If max isn't valid, ignore filter
      if (max !== null && (Number.isNaN(max) || max < 0)) {
        L.filter(); // clears filter
        return;
      }

      // Only apply price filter on tabs with "price" column
      if (activeTab === 1 || activeTab === 2 || activeTab === 3) {
        L.filter(item => {
          const v = item.values();
          // item tab uses v.price
          // incident tab uses v.price
          // traits tab uses v.add (add cost) but we map it also into v.price for filtering convenience
          const p = Number(v.price || 0);
          return (max === null) ? true : (p <= max);
        });
      } else {
        L.filter(); // clear filters for other tabs
      }
    }

    // =========================
    // Row click -> Command Builder
    // =========================
    function wireRowClicks(containerId, mode) {
      // mode: items/incidents/traits/commands
      $(`#${containerId} tbody`).on("click", "tr", function() {
        const $tr = $(this);
        const nameCell = $tr.find(".name,.abr,.usage").first().text().trim();
        const priceCell = $tr.find(".price,.add").first().text().trim();

        let cmd = "";
        let hint = "";

        if (mode === "items") {
          // Best guess: !buy item qty
          cmd = `!buy ${nameCell} 1`;
          hint = `Item selected (${priceCell}). Edit quantity if needed, then copy.`;
        } else if (mode === "incidents") {
          cmd = `!buy ${nameCell}`;
          hint = `Incident selected (${priceCell}). Copy and run in chat.`;
        } else if (mode === "traits") {
          // Traits usually need a trait command, but you can customize this format if your bot expects something else
          // Using a safe, obvious placeholder:
          cmd = `!trait ${nameCell}`;
          hint = `Genetics selected. If your integration uses a different command, adjust this format.`;
        } else if (mode === "commands") {
          // If usage exists, use it directly
          cmd = nameCell;
          hint = `Terminal command selected. Copy and run in chat.`;
        }

        setBuilder(cmd, hint);
      });
    }

    // =========================
    // ViewerData: Leaderboards + Lookup
    // =========================
    async function loadViewerData() {
      try {
        const res = await fetch(viewerDataURL + "?cb=" + Date.now(), { cache: "no-store" });
        const data = await res.json();
        if (!data || !data.viewers) return;

        const viewers = Array.isArray(data.viewers) ? data.viewers : [];

        const topCoins = [...viewers].sort((a,b) => (b.coins||0) - (a.coins||0)).slice(0,10);
        const topKarma = [...viewers].sort((a,b) => (b.karma||0) - (a.karma||0)).slice(0,10);

        $("#coinsBoard").html(topCoins.map(v => `<tr><td>${escapeHtml(v.username||"")}</td><td>${Number(v.coins||0)}</td></tr>`).join(""));
        $("#karmaBoard").html(topKarma.map(v => `<tr><td>${escapeHtml(v.username||"")}</td><td>${Number(v.karma||0)}</td></tr>`).join(""));

        const now = new Date();
        $("#coinsUpdated").text(`Updated ${now.toLocaleTimeString()}`);
        $("#karmaUpdated").text(`Updated ${now.toLocaleTimeString()}`);
      } catch (e) {
        // keep quiet, just log
        console.log("ViewerData load error:", e);
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    async function lookupViewer() {
      const name = ($("#viewerSearch").val() || "").trim().toLowerCase();
      if (!name) {
        $("#viewerResult").text("Please enter a username.");
        return;
      }

      try {
        const res = await fetch(viewerDataURL + "?cb=" + Date.now(), { cache: "no-store" });
        const data = await res.json();
        if (!data || !data.viewers) {
          $("#viewerResult").text("Viewer data not available yet.");
          return;
        }

        const viewers = Array.isArray(data.viewers) ? data.viewers : [];
        const v = viewers.find(x => (x.username||"").toLowerCase() === name);

        if (!v) {
          $("#viewerResult").text("User not found in the colony database yet (try chatting once).");
          return;
        }

        const pawn = v.pawnName || v.pawn || v.colonist || "Not assigned";
        $("#viewerResult").html(
          `Viewer: <span class="cmd-text">${escapeHtml(v.username)}</span><br>` +
          `üí∞ Coins: <b>${Number(v.coins||0)}</b><br>` +
          `üî• Karma: <b>${Number(v.karma||0)}</b><br>` +
          `üßë Pawn: <b>${escapeHtml(pawn)}</b>`
        );
      } catch (e) {
        $("#viewerResult").text("Lookup failed. Check console for details.");
        console.log(e);
      }
    }

    $("#viewerLookupBtn").on("click", lookupViewer);
    $("#viewerSearch").on("keydown", function(e){ if(e.key==="Enter") lookupViewer(); });

    // =========================
    // Boot: Load Lists
    // =========================
    async function boot() {
      // Twitch embeds
      $("#twitchPlayer").attr("src", `https://player.twitch.tv/?channel=${twitchChannel}&parent=${twitchParent}&muted=false`);
      $("#twitchChat").attr("src", `https://www.twitch.tv/embed/${twitchChannel}/chat?parent=${twitchParent}&darkpopout`);

      setStatus("BOOT: Loading Inventory‚Ä¶");
      try {
        const data = await loadJSON(itemListURL);
        const items = (data && Array.isArray(data.items)) ? data.items : [];

        // normalize
        const normalized = items
          .filter(i => Number(i.price || 0) > 0)
          .map(i => ({
            name: i.abr || i.name || i.defName || "",
            abr:  i.abr || i.name || i.defName || "",
            price: Number(i.price || 0),
            category: i.category || i.type || "‚Äî"
          }));

        itemList = new List("items", {
          valueNames: ["abr","price","category","name"],
          item: `<tr>
                  <td class="abr font-weight-bold"></td>
                  <td class="price text-success"></td>
                  <td class="category muted"></td>
                </tr>`
        }, normalized);

      } catch (e) {
        console.log(e);
        setStatus("ERROR: Inventory feed failed to load.", false);
      }

      setStatus("BOOT: Loading Incidents‚Ä¶");
      try {
        const data = await loadJSON(incidentListURL);
        const inc = (data && Array.isArray(data.incitems)) ? data.incitems : [];

        const normalized = inc
          .filter(i => Number(i.price || 0) > 0)
          .map(i => ({
            abr: i.abr || i.name || i.defName || "",
            name: i.abr || i.name || i.defName || "",
            price: Number(i.price || 0),
            karmatype: i.karmatype || i.karmaType || i.karma || "‚Äî"
          }));

        incidentList = new List("incidents", {
          valueNames: ["abr","price","karmatype","name"],
          item: `<tr>
                  <td class="abr font-weight-bold"></td>
                  <td class="price text-danger"></td>
                  <td class="karmatype"></td>
                </tr>`
        }, normalized);

      } catch (e) {
        console.log(e);
        setStatus("ERROR: Incidents feed failed to load.", false);
      }

      setStatus("BOOT: Loading Genetics‚Ä¶");
      try {
        const data = await loadJSON(shopExtURL);

        const combined = [];

        // Traits
        if (data && Array.isArray(data.traits)) {
          data.traits.forEach(t => {
            combined.push({
              name: t.defName || t.name || "",
              desc: t.description || "",
              add: Number(t.addPrice || 0),
              rem: Number(t.removePrice || 0),
              // For filtering by price, treat "price" as add cost
              price: Number(t.addPrice || 0)
            });
          });
        }

        // Races (enabled)
        if (data && Array.isArray(data.races)) {
          data.races.filter(r => r.enabled).forEach(r => {
            combined.push({
              name: (r.defName || r.name || "") + " (Race)",
              desc: r.description || "",
              add: Number(r.price || 0),
              rem: "N/A",
              price: Number(r.price || 0)
            });
          });
        }

        traitList = new List("traits", {
          valueNames: ["name","desc","add","rem","price"],
          item: `<tr>
                  <td class="name text-warning font-weight-bold"></td>
                  <td class="desc small"></td>
                  <td class="add"></td>
                  <td class="rem"></td>
                </tr>`
        }, combined);

      } catch (e) {
        console.log(e);
        setStatus("ERROR: Genetics feed failed to load.", false);
      }

      setStatus("BOOT: Loading Terminal Commands‚Ä¶");
      try {
        const cmds = await loadJSON(commandsURL);
        const arr = Array.isArray(cmds) ? cmds : [];

        // normalize for list.js
        arr.forEach(c => {
          c.name = c.usage || c.name || "";
          c.price = 0;
        });

        commandList = new List("commands", {
          valueNames: ["name","usage","description","userLevel","price"],
          item: `<tr>
                  <td class="usage cmd-text"></td>
                  <td class="description small"></td>
                  <td class="userLevel font-weight-bold"></td>
                </tr>`
        }, arr);

      } catch (e) {
        console.log(e);
        setStatus("ERROR: Commands feed failed to load.", false);
      }

      // Wire row clicks for command builder
      wireRowClicks("items", "items");
      wireRowClicks("incidents", "incidents");
      wireRowClicks("traits", "traits");
      wireRowClicks("commands", "commands");

      // Search + Max price filter
      $("#searchBar").on("keyup", function() {
        applySearchToActive($(this).val() || "");
      });
      $("#priceMax").on("keyup change", function() {
        applyFiltersToActive();
      });

      // Builder buttons
      $("#copyBtn").on("click", async () => {
        const val = $("#builderInput").val() || "";
        if (!val.trim()) return toast("Nothing to copy.");
        await copyToClipboard(val);
      });

      $("#copyOpenBtn").on("click", async () => {
        const val = $("#builderInput").val() || "";
        if (!val.trim()) return toast("Nothing to copy.");
        await copyToClipboard(val);
        openTwitchChat();
      });

      $("#clearBtn").on("click", () => {
        setBuilder("", "Waiting for selection‚Ä¶");
      });

      // Start on Inventory tab
      showTab(1);

      // Start leaderboards
      loadViewerData();
      setInterval(loadViewerData, 5000);

      setStatus("SYSTEM: Data feeds online. Ready.");
    }

    // Boot
    boot();
  </script>
</body>
</html>
